name: Stan Asset & Template Ingest

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Ingestion Mode'
        required: true
        type: choice
        options:
          - template        # Full UnityPackage to stan-templates
          - asset-single    # Single file to stan-assets/[type]
          - asset-rip       # UnityPackage to be stripped into stan-assets
      source_url:
        description: 'Public URL of the asset/package'
        required: true
        type: string
      asset_type:
        description: 'Sub-folder/Category (e.g., sprites, models, racing)'
        required: true
        default: 'misc'
        type: string
      description:
        description: 'Description for Vectorize indexing'
        required: false
        type: string

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: High-Speed Download
        run: |
          mkdir -p raw_data
          curl -L "${{ github.event.inputs.source_url }}" -o raw_data/incoming
          echo "‚úÖ Downloaded from ${{ github.event.inputs.source_url }}"

      - name: Process Ingestion
        id: process
        run: |
          mkdir -p processed_data
          MODE="${{ github.event.inputs.mode }}"
          
          if [ "$MODE" == "template" ]; then
            echo "üì¶ Mode: Template. Copying to templates/${{ github.event.inputs.asset_type }}"
            mkdir -p "processed_data/templates/${{ github.event.inputs.asset_type }}"
            cp raw_data/incoming "processed_data/templates/${{ github.event.inputs.asset_type }}/base.unitypackage"
          
          elif [ "$MODE" == "asset-single" ]; then
            echo "üñºÔ∏è Mode: Single Asset. Copying to library/${{ github.event.inputs.asset_type }}"
            mkdir -p "processed_data/library/${{ github.event.inputs.asset_type }}"
            # Try to guess extension or use a generic name
            cp raw_data/incoming "processed_data/library/${{ github.event.inputs.asset_type }}/asset_$(date +%s)"
          
          elif [ "$MODE" == "asset-rip" ]; then
            echo "ü™ö Mode: Asset Ripper. Extracting UnityPackage..."
            mkdir -p rip_temp
            # UnityPackages are usually tar.gz
            # This is a simplified ripper logic
            tar -xzf raw_data/incoming -C rip_temp || true
            
            # Basic reconstruction:
            # Each folder in a .unitypackage has an 'asset' file and a 'pathname' file
            find rip_temp -name "pathname" | while read p; do
              DIR=$(dirname "$p")
              FINAL_PATH=$(cat "$p")
              if [ -f "$DIR/asset" ]; then
                mkdir -p "processed_data/library/ripped/$(dirname "$FINAL_PATH")"
                cp "$DIR/asset" "processed_data/library/ripped/$FINAL_PATH"
              fi
            done
            echo "‚úÖ Ripping complete"
          fi

      - name: Sync to Cloudflare R2
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: |
          pip install awscli
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          
          MODE="${{ github.event.inputs.mode }}"
          if [ "$MODE" == "template" ]; then
            BUCKET="stan-templates"
          else
            BUCKET="stan-assets"
          fi
          
          echo "üöÄ Syncing to R2 Bucket: $BUCKET"
          aws s3 sync processed_data/ s3://$BUCKET/ \
            --endpoint-url $R2_ENDPOINT
          
      - name: Notify Backend for Vectorize
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/admin/index-notify" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "mode": "${{ github.event.inputs.mode }}",
              "type": "${{ github.event.inputs.asset_type }}",
              "description": "${{ github.event.inputs.description }}",
              "url": "${{ github.event.inputs.source_url }}",
              "status": "completed"
            }'
