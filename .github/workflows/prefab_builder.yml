name: Prefab Builder

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      prefabs:
        description: 'JSON array of prefab definitions'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rclone & Download
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}"
          if [ -z "$R2_ENDPOINT" ]; then
             R2_ENDPOINT="https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com"
          else
             # Sanitize: Strip potential bucket path
             R2_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          fi
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = $R2_ENDPOINT
          acl = private
          EOF
          rclone copy "r2:stan-projects/${{ inputs.project_id }}" ./project --progress

      - name: Inject PrefabBuilder Script
        run: |
          cat > PrefabBuilder.cs << 'EOF'
          using UnityEngine;
          using UnityEditor;
          using System.Collections.Generic;
          public class PrefabBuilder {
              public static void Execute() {
                  var prefabsJson = System.Environment.GetEnvironmentVariable("PREFABS");
                  var prefabList = JsonUtility.FromJson<PrefabList>(prefabsJson);
                  foreach(var p in prefabList.prefabs) {
                      var go = new GameObject(p.name);
                      // Add components... logic here
                      PrefabUtility.SaveAsPrefabAsset(go, $"Assets/{p.name}.prefab");
                      Object.DestroyImmediate(go);
                  }
              }
          }
          [System.Serializable] public class PrefabList { public List<PrefabDef> prefabs; }
          [System.Serializable] public class PrefabDef { public string name; }
          EOF
          mkdir -p project/Assets/Editor
          mv PrefabBuilder.cs project/Assets/Editor/

      - name: Run Prefab Builder (GameCI)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          PREFABS: ${{ inputs.prefabs }}
        with:
          projectPath: ./project
          unityVersion: 2022.3.10f1
          buildMethod: PrefabBuilder.Execute
          customParameters: -nographics -batchmode -quit
          allowDirtyBuild: true
          versioning: None

      - name: Upload Changes
        run: |
          rclone sync ./project "r2:stan-projects/${{ inputs.project_id }}" \
            --progress \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**'

      - name: Return License
        uses: game-ci/unity-return-license@v2
        if: always()
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
