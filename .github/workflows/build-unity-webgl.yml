name: Build Unity WebGL

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID from STAN'
        required: true
        type: string
      r2_path:
        description: 'R2 path to Unity project (in stan-projects)'
        required: true
        type: string
      game_name:
        description: 'Game name for display'
        required: true
        type: string
      slug:
        description: 'URL-friendly slug for deployment'
        required: true
        type: string
      is_paid:
        description: 'Is paid user (true/false)'
        required: false
        type: string
        default: 'false'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Download Unity project from R2 (Source bucket)
      - name: Download Unity Project from R2
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_SOURCE_BUCKET: stan-projects
        run: |
          echo "üì• Downloading Unity project from R2..."
          
          # Install AWS CLI
          pip install awscli
          
          # Configure for R2
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          
          # Download project
          mkdir -p UnityProject
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.r2_path }} ./UnityProject \
            --endpoint-url $R2_ENDPOINT
          
          echo "‚úÖ Project downloaded"
          ls -la UnityProject/
      
      # Cache Unity Library folder for faster builds
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: UnityProject/Library
          key: Library-${{ github.event.inputs.slug }}
          restore-keys: |
            Library-
      
      # Build Unity WebGL
      - name: Build Unity WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: ./UnityProject
          targetPlatform: WebGL
          unityVersion: 2022.3.10f1
          buildName: ${{ github.event.inputs.game_name }}
      
      # Inject Adsterra Ads
      - name: Update project metadata with build settings
        run: |
          echo "üìä Fetching build settings from database..."
          
          # Fetch build settings from backend
          RESPONSE=$(curl -s "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ github.event.inputs.project_id }}/build-settings")
          
          # Extract isKidsSafe flag (default to false if not found)
          IS_KIDS_SAFE=$(echo "$RESPONSE" | jq -r '.is_kids_safe // false')
          
          echo "üéØ Kids Safe Mode: $IS_KIDS_SAFE"
          
          # Update stan-project.json with isKidsSite flag
          if [ -f "UnityProject/stan-project.json" ]; then
            jq ".isKidsSite = $IS_KIDS_SAFE" UnityProject/stan-project.json > tmp.json
            mv tmp.json UnityProject/stan-project.json
            echo "‚úÖ Updated stan-project.json with isKidsSite=$IS_KIDS_SAFE"
          else
            echo "‚ö†Ô∏è stan-project.json not found, skipping update"
          fi
      
      - name: Inject Stan Monetization
        run: |
          echo "üí∞ Injecting Adsterra ads..."
          node inject-ads.js
          echo "‚úÖ Ads injected"
      
      # Deploy to R2 Games Bucket (ORDERLY)
      - name: Deploy to R2 Games Bucket
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_GAMES_BUCKET: stan-games
        run: |
          echo "üöÄ Deploying WebGL build to R2 pool..."
          
          # Install AWS CLI
          pip install awscli
          
          # Configure for R2
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          
          # Upload build artifacts to the slug folder in stan-games
          # The gateway worker expects files at R2:stan-games/[slug]/index.html
          aws s3 sync build/WebGL/WebGL s3://stan-games/${{ github.event.inputs.slug }} \
            --endpoint-url $R2_ENDPOINT \
            --delete
          
          echo "‚úÖ Deployed to R2: https://games.stanlink.online/${{ github.event.inputs.slug }}"
      
      # Notify STAN backend of completion
      - name: Notify STAN Backend
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.inputs.project_id }}",
              "status": "success",
              "deploy_url": "https://games.stanlink.online/${{ github.event.inputs.slug }}"
            }'
      
      # Cleanup
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          rm -rf ./UnityProject
          rm -rf build/
          echo "‚úÖ Cleanup complete"
