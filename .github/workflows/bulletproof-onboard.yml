name: Bulletproof Unity Onboard

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      template_package:
        description: 'Unity package name or empty for base project'
        required: false
        default: ''
      is_paid:
        description: 'Is paid user (true/false)'
        required: true
        default: 'false'
      allowed_domains:
        description: 'Comma-separated allowed domains'
        required: true
        default: 'games.stanlink.online'

jobs:
  setup-unity:
    runs-on: ubuntu-latest
    outputs:
      unity-path: ${{ steps.setup.outputs.unity-path }}
      activation-method: ${{ steps.activation.outputs.method }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Cache Unity Installation
        id: cache-unity
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v2
      
      - name: Install Unity
        id: setup
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ“¦ Installing Unity Editor..."
          
          # Install Unity Hub
          wget -qO - https://hub.unity3d.com/linux/keys/public | sudo apt-key add -
          echo 'deb https://hub.unity3d.com/linux/repos/deb stable main' | sudo tee /etc/apt/sources.list.d/unityhub.list
          sudo apt update
          sudo apt install unityhub -y
          
          # Create Unity directory
          sudo mkdir -p /opt/unity
          
          # Install Unity Editor
          unityhub --headless install --version 2022.3.21f1 --changeset bf09ca542b87 --installPath /opt/unity
          
          # Set permissions
          sudo chmod -R 755 /opt/unity/
          
          # Set output
          echo "unity-path=/opt/unity/2022.3.21f1/Editor/Unity" >> $GITHUB_OUTPUT
          
          echo "âœ… Unity installation completed"
      
      - name: Set Unity Path (Cached)
        if: steps.cache-unity.outputs.cache-hit == 'true'
        run: |
          echo "unity-path=/opt/unity/2022.3.21f1/Editor/Unity" >> $GITHUB_OUTPUT
      
      - name: Activate Unity (Multiple Methods)
        id: activation
        run: |
          UNITY_PATH="/opt/unity/2022.3.21f1/Editor/Unity"
          
          echo "ðŸ”‘ Attempting Unity activation with multiple methods..."
          
          # Method 1: License File (Most Reliable)
          echo "ðŸ“„ Trying license file method..."
          mkdir -p ~/.local/share/unity3d/Unity/
          
          if [ -n "${{ secrets.UNITY_LICENSE }}" ]; then
            echo "${{ secrets.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
            
            # Test license file
            if "$UNITY_PATH" -quit -batchmode -nographics -createProject /tmp/license_test -logFile license_test.log; then
              echo "âœ… License file activation successful!"
              echo "method=license_file" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ License file method failed"
              cat license_test.log || true
            fi
          fi
          
          # Method 2: Personal License
          echo "ðŸ‘¤ Trying personal license method..."
          if [ -n "${{ secrets.UNITY_EMAIL }}" ] && [ -n "${{ secrets.UNITY_PASSWORD }}" ]; then
            if "$UNITY_PATH" -quit -batchmode -nographics -username "${{ secrets.UNITY_EMAIL }}" -password "${{ secrets.UNITY_PASSWORD }}" -logFile personal_test.log; then
              echo "âœ… Personal license activation successful!"
              echo "method=personal_license" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Personal license method failed"
              cat personal_test.log || true
            fi
          fi
          
          # Method 3: Unity Hub
          echo "ðŸ¢ Trying Unity Hub method..."
          if [ -n "${{ secrets.UNITY_EMAIL }}" ] && [ -n "${{ secrets.UNITY_PASSWORD }}" ]; then
            if unityhub --headless login --username "${{ secrets.UNITY_EMAIL }}" --password "${{ secrets.UNITY_PASSWORD }}"; then
              if unityhub --headless activate --license-type personal; then
                echo "âœ… Unity Hub activation successful!"
                echo "method=unity_hub" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            echo "âŒ Unity Hub method failed"
          fi
          
          # Method 4: Manual Activation (if we have stored response)
          echo "ðŸ”§ Trying manual activation method..."
          if [ -n "${{ secrets.UNITY_MANUAL_LICENSE }}" ]; then
            # Generate activation request
            "$UNITY_PATH" -quit -batchmode -nographics -createManualActivationFile -logFile manual_request.log
            
            if [ -f Unity_v*.alf ]; then
              echo "ðŸ“„ Manual activation file created"
              
              # Apply stored manual license
              echo "${{ secrets.UNITY_MANUAL_LICENSE }}" | base64 -d > Unity_lic.ulf
              
              if "$UNITY_PATH" -quit -batchmode -nographics -manualLicenseFile Unity_lic.ulf -logFile manual_apply.log; then
                echo "âœ… Manual activation successful!"
                echo "method=manual_activation" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "âŒ Manual activation failed"
                cat manual_apply.log || true
              fi
            fi
          fi
          
          # All methods failed
          echo "âŒ All activation methods failed!"
          echo "method=failed" >> $GITHUB_OUTPUT
          exit 1

  onboard-project:
    runs-on: ubuntu-latest
    needs: setup-unity
    if: needs.setup-unity.outputs.activation-method != 'failed'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Clone Base Project
        run: |
          echo "ðŸ“¦ Cloning stanstarter base project..."
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          echo "âœ… Base project cloned"
      
      - name: Restore Unity Cache
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v2
      
      - name: Restore Unity License
        run: |
          echo "ðŸ”‘ Restoring Unity license using method: ${{ needs.setup-unity.outputs.activation-method }}"
          
          case "${{ needs.setup-unity.outputs.activation-method }}" in
            "license_file")
              mkdir -p ~/.local/share/unity3d/Unity/
              echo "${{ secrets.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
              ;;
            "personal_license")
              /opt/unity/2022.3.21f1/Editor/Unity -quit -batchmode -nographics -username "${{ secrets.UNITY_EMAIL }}" -password "${{ secrets.UNITY_PASSWORD }}" -logFile restore_license.log
              ;;
            "unity_hub")
              unityhub --headless login --username "${{ secrets.UNITY_EMAIL }}" --password "${{ secrets.UNITY_PASSWORD }}"
              unityhub --headless activate --license-type personal
              ;;
            "manual_activation")
              echo "${{ secrets.UNITY_MANUAL_LICENSE }}" | base64 -d > Unity_lic.ulf
              /opt/unity/2022.3.21f1/Editor/Unity -quit -batchmode -nographics -manualLicenseFile Unity_lic.ulf -logFile restore_manual.log
              ;;
          esac
          
          echo "âœ… Unity license restored"
      
      - name: Import Template (if specified)
        if: ${{ inputs.template_package != '' }}
        env:
          STAN_TEMPLATES_PUBLIC_URL: ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}
        run: |
          echo "ðŸ“¥ Downloading and importing template: ${{ inputs.template_package }}"
          
          # Download template
          TEMPLATE_PATH="${{ inputs.template_package }}"
          TEMPLATE_PATH="${TEMPLATE_PATH#templates/}"
          ENCODED_PATH=$(echo "$TEMPLATE_PATH" | sed 's/ /%20/g')
          FULL_URL="${STAN_TEMPLATES_PUBLIC_URL}/${ENCODED_PATH}"
          
          curl -L -f "$FULL_URL" -o template.unitypackage
          
          # Import template
          /opt/unity/2022.3.21f1/Editor/Unity \
            -quit \
            -batchmode \
            -nographics \
            -projectPath ./project \
            -importPackage $(pwd)/template.unitypackage \
            -logFile import_template.log
          
          echo "âœ… Template imported successfully"
      
      - name: Configure Project
        run: |
          echo "âš™ï¸ Configuring project settings..."
          
          # Replace placeholders in core scripts
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs
          
          # Create stan-config.json
          cat > project/Assets/_StanCore/Resources/stan-config.json << EOF
          {
            "domains": ["${{ inputs.allowed_domains }}"],
            "projectId": "${{ inputs.project_id }}",
            "isPaid": ${{ inputs.is_paid }}
          }
          EOF
          
          echo "âœ… Project configured"
      
      - name: Test Unity Project
        run: |
          echo "ðŸ§ª Testing Unity project compilation..."
          
          /opt/unity/2022.3.21f1/Editor/Unity \
            -quit \
            -batchmode \
            -nographics \
            -projectPath ./project \
            -executeMethod UnityEditor.EditorApplication.Exit \
            -logFile test_compile.log
          
          echo "âœ… Project compilation test passed"
      
      - name: Upload to R2
        run: |
          echo "â˜ï¸ Uploading project to R2..."
          
          # Install rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # Configure rclone
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com
          region = auto
          EOF
          
          # Create bucket path and upload
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} \
            --progress \
            --exclude '.git/**' \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**'
          
          echo "âœ… Project uploaded to R2"
      
      - name: Notify Backend
        run: |
          echo "ðŸ“¡ Notifying backend of successful onboarding..."
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "onboarded",
              "template": "${{ inputs.template_package }}",
              "templateImported": true,
              "unityActivated": true,
              "activationMethod": "${{ needs.setup-unity.outputs.activation-method }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Backend notified"
      
      - name: Success Summary
        run: |
          echo "ðŸŽ‰ Project onboarding completed successfully!"
          echo "=================================="
          echo "ðŸ“‹ Project ID: ${{ inputs.project_id }}"
          echo "ðŸ“¦ Template: ${{ inputs.template_package || 'Base project only' }}"
          echo "ðŸ”‘ Unity Activation: ${{ needs.setup-unity.outputs.activation-method }}"
          echo "â˜ï¸ Location: R2 stan-projects/${{ inputs.project_id }}"
          echo "=================================="

  handle-failure:
    runs-on: ubuntu-latest
    needs: setup-unity
    if: needs.setup-unity.outputs.activation-method == 'failed'
    
    steps:
      - name: Fallback to Base Project
        run: |
          echo "âš ï¸ Unity activation failed - creating base project without Unity processing"
          
          # Clone base project
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          
          # Configure without Unity
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs || true
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs || true
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs || true
          
          # Upload to R2
          curl https://rclone.org/install.sh | sudo bash
          
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com
          region = auto
          EOF
          
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} --progress
          
          # Notify backend of fallback
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "onboarded_base_only",
              "template": "",
              "templateImported": false,
              "unityActivated": false,
              "activationMethod": "failed",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Base project created as fallback"