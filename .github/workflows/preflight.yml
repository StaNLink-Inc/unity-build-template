name: Preflight Check

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      slug:
        description: 'Project slug'
        required: true
      callback_url:
        description: 'Backend callback URL'
        required: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üöÄ Preflight Started
        run: |
          curl -X POST "${{ inputs.callback_url }}/api/build/preflight-status" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{ "projectId": "${{ inputs.project_id }}", "status": "running", "message": "Running preflight checks..." }'
      
      - name: üì• Download Project from R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          # Install AWS CLI
          pip install awscli
          # Configure for R2
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region auto
          # Download project files from R2
          aws s3 sync s3://stan-projects/${{ inputs.slug }}/ ./project/ \
            --endpoint-url ${{ secrets.R2_ENDPOINT }} \
            --region auto
      
      - name: üîç Check Project Structure
        id: structure_check
        run: |
          echo "Checking Unity project structure..."
          
          # Check for required folders
          if [ ! -d "project/Assets" ]; then
            echo "error=Missing Assets folder" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ ! -d "project/Assets/Scripts" ]; then
            echo "error=Missing Assets/Scripts folder" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check for at least one scene
          if [ ! -d "project/Assets/Scenes" ] || [ -z "$(ls -A project/Assets/Scenes/*.unity 2>/dev/null)" ]; then
            echo "error=No Unity scenes found in Assets/Scenes/" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Project structure valid"
      
      - name: üîç Validate C# Scripts
        id: script_check
        run: |
          echo "Validating C# scripts..."
          
          # Find all .cs files
          cs_files=$(find project/Assets/Scripts -name "*.cs" 2>/dev/null || echo "")
          
          if [ -z "$cs_files" ]; then
            echo "error=No C# scripts found" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Basic syntax check (look for common errors)
          error_found=false
          error_details=""
          
          while IFS= read -r file; do
            # Check for unclosed braces
            open_braces=$(grep -o '{' "$file" | wc -l)
            close_braces=$(grep -o '}' "$file" | wc -l)
            
            if [ "$open_braces" -ne "$close_braces" ]; then
              error_found=true
              error_details="$error_details\n$(basename $file): Mismatched braces (open: $open_braces, close: $close_braces)"
            fi
            
            # Check for basic Unity requirements
            if grep -q "MonoBehaviour" "$file"; then
              if ! grep -q "using UnityEngine;" "$file"; then
                error_found=true
                # FIX: Ensure this is a single line with proper escaping if needed
                error_details="$error_details\n$(basename $file): Missing 'using UnityEngine;'
"
              fi
            fi
          done <<< "$cs_files"
          
          if [ "$error_found" = true ]; then
            echo "error=Script validation failed:$error_details" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ All scripts valid"
      
      - name: üîç Check Dependencies
        id: dependency_check
        run: |
          echo "Checking Unity dependencies..."
          
          # Check if Packages/manifest.json exists
          if [ ! -f "project/Packages/manifest.json" ]; then
            echo "error=Missing Packages/manifest.json" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Validate JSON
          if ! jq empty project/Packages/manifest.json 2>/dev/null; then
            echo "error=Invalid manifest.json format" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Dependencies valid"
      
      - name: üîç Estimate Build Size
        id: size_check
        run: |
          echo "Estimating build size..."
          
          # Calculate project size
          size_kb=$(du -sk project | cut -f1)
          size_mb=$((size_kb / 1024))
          
          echo "Project size: ${size_mb}MB"
          echo "size_mb=$size_mb" >> $GITHUB_OUTPUT
          
          # Warn if too large
          if [ $size_mb -gt 500 ]; then
            echo "‚ö†Ô∏è Large project detected (${size_mb}MB). Build may take longer."
          fi
      
      - name: ‚úÖ Preflight Passed
        if: success()
        run: |
          curl -X POST "${{ inputs.callback_url }}/api/build/preflight-status" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{ "projectId": "${{ inputs.project_id }}", "status": "passed", "message": "All preflight checks passed!", "details": { "projectSize": "${{ steps.size_check.outputs.size_mb }}MB", "estimatedBuildTime": "10-30 minutes" } }'
      
      - name: ‚ùå Preflight Failed
        if: failure()
        run: |
          # Collect all errors
          structure_error="${{ steps.structure_check.outputs.error }}"
          script_error="${{ steps.script_check.outputs.error }}"
          dependency_error="${{ steps.dependency_check.outputs.error }}"
          
          error_message="Preflight check failed:"
          [ -n "$structure_error" ] && error_message="$error_message\n- $structure_error"
          [ -n "$script_error" ] && error_message="$error_message\n- $script_error"
          [ -n "$dependency_error" ] && error_message="$error_message\n- $dependency_error"
          
          curl -X POST "${{ inputs.callback_url }}/api/build/preflight-status" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d "{ \"projectId\": \"${{ inputs.project_id }}\", \"status\": \"failed\", \"message\": \"$error_message\", \"errors\": { \"structure\": \"$structure_error\", \"scripts\": \"$script_error\", \"dependencies\": \"$dependency_error\" } }"
