name: Onboard New Project

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      template_package:
        description: 'Unity package name or empty'
        required: false
        default: ''
      is_paid:
        description: 'Is paid user (true/false)'
        required: true
        default: 'false'
      allowed_domains:
        description: 'Comma-separated allowed domains'
        required: true
        default: 'games.stanlink.online,kids.games.stanlink.online'

jobs:
  onboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Template Repo
        uses: actions/checkout@v3

      - name: Clone Base Project (StanStarter)
        run: |
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git

      - name: Download Template (if specified)
        if: ${{ inputs.template_package != '' }}
        env:
          STAN_TEMPLATES_PUBLIC_URL: ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}
        run: |
          # Clean path logic
          TEMPLATE_PATH="${{ inputs.template_package }}"
          TEMPLATE_PATH="${TEMPLATE_PATH#templates/}"
          ENCODED_PATH=$(echo "$TEMPLATE_PATH" | sed 's/ /%20/g')
          FULL_URL="${STAN_TEMPLATES_PUBLIC_URL}/${ENCODED_PATH}"
          
          echo "ðŸ“¥ Downloading template from: $FULL_URL"
          curl -L -f "$FULL_URL" -o project/template.unitypackage
          echo "HAS_TEMPLATE=true" >> $GITHUB_ENV

      - name: Import Template & Configure (via GameCI)
        if: ${{ env.HAS_TEMPLATE == 'true' }}
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ./project
          unityVersion: 2022.3.10f1
          # We use a dummy build method or custom parameters to just import
          # But -importPackage requires the Editor to be running.
          # We can use -executeMethod to run a script we inject, OR just rely on CLI.
          # GameCI allows customParameters override.
          # Note: We need a command that runs and exits.
          # Trying straightforward -importPackage approach
          customParameters: -importPackage /github/workspace/project/template.unitypackage -quit -batchmode -nographics
          buildMethod: UnityEditor.EditorApplication.Exit
          allowDirtyBuild: true
          versioning: None



      - name: Inject Configuration (Shell)
        run: |
          # Replace placeholders
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs
          
          # JSON Config
          cat > project/Assets/_StanCore/Resources/stan-config.json << EOF
          {
            "domains": ["${{ inputs.allowed_domains }}"],
            "projectId": "${{ inputs.project_id }}",
            "isPaid": ${{ inputs.is_paid }}
          }
          EOF
          
          # Project Metadata
          cat > project/stan-project.json << EOF
          {
            "projectId": "${{ inputs.project_id }}",
            "template": "${{ inputs.template_package }}",
            "templateStatus": "imported",
            "createdAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "isPaid": ${{ inputs.is_paid }},
            "domains": ["${{ inputs.allowed_domains }}"]
          }
          EOF

      - name: Setup Rclone & Upload
        run: |
          curl https://rclone.org/install.sh | sudo bash
          
          mkdir -p ~/.config/rclone
          # Fix: R2 configuration using s3 provider + correct endpoint logic
          # If secret R2_ENDPOINT is provided, use it. Otherwise construct it.
          # Default to the one seen in logs if secret missing (but valid s3 syntax)
          
          R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}"
          if [ -z "$R2_ENDPOINT" ]; then
             R2_ENDPOINT="https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com"
          else
             # Sanitize: Strip potential bucket path from secret (fix 400 Bad Request)
             R2_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          fi

          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = $R2_ENDPOINT
          acl = private
          EOF
          
          # Fix: Do NOT run mkdir on the bucket itself if it might fail. 
          # Sync handles directory creation.
          # If we surely want to create a 'folder' (prefix), rclone touch helps, or just sync.
          
          echo "â˜ï¸ Uploading to stan-projects/${{ inputs.project_id }}..."
          
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} \
            --progress \
            --transfers 8 \
            --exclude '.git/**' \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**' \
            --exclude 'template.unitypackage'

      - name: Notify Backend
        if: always()
        run: |
          STATUS="onboarded"
          if [ "${{ job.status }}" != "success" ]; then
             STATUS="failed"
          fi
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "'$STATUS'",
              "template": "${{ inputs.template_package }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
