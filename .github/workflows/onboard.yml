name: Onboard New Project

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      template_package:
        description: 'Unity package name (e.g., racing-template.unitypackage) or empty for no template'
        required: false
        default: ''
      is_paid:
        description: 'Is paid user (true/false)'
        required: true
        default: 'false'
      allowed_domains:
        description: 'Comma-separated allowed domains'
        required: true
        default: 'games.stanlink.online,kids.games.stanlink.online'

jobs:
  clear-cache:
    runs-on: ubuntu-latest
    if: github.event.inputs.clear_cache == 'true'
    steps:
      - name: Clear Unity Cache
        run: |
          echo "Cache cleared (no-op for manual trigger)"

  setup-unity:
    runs-on: ubuntu-latest
    outputs:
      unity-ready: ${{ steps.check-cache.outputs.cache-hit == 'true' || steps.install.outputs.unity-ready == 'true' }}
    
    steps:
      - name: Check Unity Cache
        id: check-cache
        uses: actions/cache@v3
        with:
          path: /home/runner/Unity/Hub/Editor
          key: unity-editor-2022.3.21f1-${{ runner.os }}
      
      - name: Install Unity Hub
        if: steps.check-cache.outputs.cache-hit != 'true'
        run: |
          wget -qO - https://hub.unity3d.com/linux/keys/public | sudo apt-key add -
          echo 'deb https://hub.unity3d.com/linux/repos/deb stable main' | sudo tee /etc/apt/sources.list.d/unityhub.list
          sudo apt update && sudo apt install unityhub -y
      
      - name: Install Unity Editor
        id: install
        if: steps.check-cache.outputs.cache-hit != 'true'
        run: |
          unityhub --headless install --version 2022.3.21f1 --changeset bf09ca542b87
          echo "unity-ready=true" >> $GITHUB_OUTPUT
      
      - name: Cache Unity Editor
        if: steps.install.outputs.unity-ready == 'true'
        uses: actions/cache/save@v3
        with:
          path: /home/runner/Unity/Hub/Editor
          key: unity-editor-2022.3.21f1-${{ runner.os }}

  onboard-project:
    runs-on: ubuntu-latest
    needs: setup-unity
    
    steps:
      - name: Checkout unity-build-template
        uses: actions/checkout@v3
      
      - name: Clone stanstarter base
        run: |
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
      
      - name: Restore Unity Cache
        uses: actions/cache@v3
        with:
          path: /home/runner/Unity/Hub/Editor
          key: unity-editor-2022.3.21f1-${{ runner.os }}
      
      - name: Activate Unity License
        id: unity-activation
        continue-on-error: true
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        run: |
          mkdir -p ~/.local/share/unity3d/Unity/
          echo "$UNITY_LICENSE" | tr -d '\r' > ~/.local/share/unity3d/Unity/Unity_lic.ulf
          
          /home/runner/Unity/Hub/Editor/2022.3.21f1/Editor/Unity \
            -quit \
            -batchmode \
            -nographics \
            -username "${{ secrets.UNITY_EMAIL }}" \
            -password "${{ secrets.UNITY_PASSWORD }}" \
            -logFile -
      
      - name: Download and import template (if specified and Unity activated)
        if: ${{ inputs.template_package != '' && steps.unity-activation.outcome == 'success' }}
        env:
          STAN_TEMPLATES_PUBLIC_URL: ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}
        run: |
          # Download .unitypackage from R2 using public URL
          TEMPLATE_PATH="${{ inputs.template_package }}"
          # Strip 'templates/' prefix if present
          TEMPLATE_PATH="${TEMPLATE_PATH#templates/}"
          ENCODED_PATH=$(echo "$TEMPLATE_PATH" | sed 's/ /%20/g')
          FULL_URL="${STAN_TEMPLATES_PUBLIC_URL}/${ENCODED_PATH}"
          
          echo "ðŸ“¥ Downloading template from: $FULL_URL"
          curl -L -f "$FULL_URL" -o template.unitypackage
          
          # Use the cached Unity path
          UNITY_PATH="/home/runner/Unity/Hub/Editor/2022.3.21f1/Editor/Unity"
          
          echo "Using Unity at: $UNITY_PATH"
          
          # Import using Unity CLI
          "$UNITY_PATH" \
            -quit \
            -batchmode \
            -nographics \
            -projectPath ./project \
            -importPackage $(pwd)/template.unitypackage \
            -logFile -
          
          echo "âœ… Template imported to Assets/"
      
      - name: Handle Unity activation failure
        if: ${{ steps.unity-activation.outcome == 'failure' }}
        run: |
          echo "âš ï¸ Unity activation failed - proceeding with base stanstarter project"
          echo "ðŸŽ¯ Stan AI agents will generate all game content from scratch"
          echo "ðŸ“¦ Template: ${{ inputs.template_package || 'none' }} (will be ignored)"
      
      - name: Inject project configuration
        run: |
          # Replace placeholders in StanAnalytics.cs
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' \
            project/Assets/_StanCore/Scripts/StanAnalytics.cs
          
          # Replace placeholders in StanWatermark.cs
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' \
            project/Assets/_StanCore/Scripts/StanWatermark.cs
          
          # Replace placeholders in StanDomainLock.cs
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' \
            project/Assets/_StanCore/Scripts/StanDomainLock.cs
          
          # Update stan-config.json
          cat > project/Assets/_StanCore/Resources/stan-config.json << EOF
          {
            "domains": ["${{ inputs.allowed_domains }}"],
            "projectId": "${{ inputs.project_id }}",
            "isPaid": ${{ inputs.is_paid }}
          }
          EOF
      
      - name: Create project metadata
        run: |
          # Determine actual template status
          if [ "${{ steps.unity-activation.outcome }}" = "failure" ]; then
            TEMPLATE_STATUS="failed_to_import"
            ACTUAL_TEMPLATE=""
          else
            TEMPLATE_STATUS="imported"
            ACTUAL_TEMPLATE="${{ inputs.template_package }}"
          fi
          
          cat > project/stan-project.json << EOF
          {
            "projectId": "${{ inputs.project_id }}",
            "template": "$ACTUAL_TEMPLATE",
            "templateStatus": "$TEMPLATE_STATUS",
            "createdAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "isPaid": ${{ inputs.is_paid }},
            "domains": ["${{ inputs.allowed_domains }}"]
          }
          EOF
      
      - name: Upload project to R2
        run: |
          # Install rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # Configure rclone for Cloudflare R2
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com
          acl = private
          EOF
          
          # Upload entire project to R2 stan-projects bucket
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} \
            --progress \
            --exclude '.git/**' \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**'
          
          echo "âœ… Project uploaded to R2: stan-projects/${{ inputs.project_id }}"
      
      - name: Notify backend
        run: |
          # Determine notification payload based on Unity activation
          if [ "${{ steps.unity-activation.outcome }}" = "failure" ]; then
            TEMPLATE_IMPORTED="false"
            ACTUAL_TEMPLATE=""
            STATUS_MESSAGE="onboarded_base_only"
          else
            TEMPLATE_IMPORTED="true"
            ACTUAL_TEMPLATE="${{ inputs.template_package }}"
            STATUS_MESSAGE="onboarded"
          fi
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "'$STATUS_MESSAGE'",
              "template": "'$ACTUAL_TEMPLATE'",
              "templateImported": '$TEMPLATE_IMPORTED',
              "unityActivated": "${{ steps.unity-activation.outcome == 'success' }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
      
      - name: Success
        run: |
          echo "âœ… Project ${{ inputs.project_id }} onboarded successfully!"
          if [ "${{ steps.unity-activation.outcome }}" = "failure" ]; then
            echo "âš ï¸ Unity activation failed - using base stanstarter project"
            echo "ðŸ¤– Stan AI agents will generate all game content"
            echo "ðŸ“¦ Template: none (base project only)"
          else
            echo "ðŸ“¦ Template: ${{ inputs.template_package }}"
          fi
          echo "â˜ï¸ Location: R2 stan-projects/${{ inputs.project_id }}"
