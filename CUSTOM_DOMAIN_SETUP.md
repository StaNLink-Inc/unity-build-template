# Custom Domain Setup for R2 Buckets

## ğŸ¯ Why Custom Domains?

### Dev URLs (pub-xxxxx.r2.dev) Limitations:
- âŒ Rate limited (can't handle many users)
- âŒ Generic branding
- âŒ No custom caching rules
- âŒ Limited to Cloudflare's default CDN settings

### Custom Domains Benefits:
- âœ… **Unlimited bandwidth** - No rate limits!
- âœ… **Professional branding** - stantemplates.cloud.stanlink.online
- âœ… **Better performance** - Full Cloudflare CDN
- âœ… **Scalable** - Handle millions of users
- âœ… **Custom rules** - Caching, security, redirects
- âœ… **Analytics** - Track usage with Cloudflare Analytics

---

## ğŸš€ Setup Guide

### Step 1: Add Custom Domain to stan-templates

1. **Go to R2 Bucket Settings**
   ```
   Cloudflare Dashboard â†’ R2 â†’ stan-templates â†’ Settings
   ```

2. **Scroll to "Custom Domains" Section**
   - Click "Connect Domain"

3. **Enter Your Domain**
   ```
   stantemplates.cloud.stanlink.online
   ```

4. **DNS Configuration**
   - Cloudflare will show you the DNS records needed
   - If stanlink.online is already on Cloudflare, it will auto-configure!
   - If not, add these DNS records:
     ```
     Type: CNAME
     Name: stantemplates.cloud
     Target: [shown by Cloudflare]
     Proxy: Enabled (orange cloud)
     ```

5. **Wait for Propagation**
   - Usually takes 5-10 minutes
   - Check status in R2 bucket settings
   - Test with: `curl -I https://stantemplates.cloud.stanlink.online`

---

### Step 2: Add Custom Domain to stan-assets

1. **Go to R2 Bucket Settings**
   ```
   Cloudflare Dashboard â†’ R2 â†’ stan-assets â†’ Settings
   ```

2. **Scroll to "Custom Domains" Section**
   - Click "Connect Domain"

3. **Enter Your Domain**
   ```
   stanassets.cloud.stanlink.online
   ```

4. **DNS Configuration**
   - Same process as above
   - Add CNAME record for stanassets.cloud

5. **Wait for Propagation**
   - Test with: `curl -I https://stanassets.cloud.stanlink.online`

---

## ğŸ”§ DNS Records Summary

If stanlink.online is on Cloudflare, these are auto-created:

```
Type: CNAME
Name: stantemplates.cloud.stanlink.online
Target: [auto-generated by Cloudflare]
Proxy: Enabled â˜ï¸

Type: CNAME
Name: stanassets.cloud.stanlink.online
Target: [auto-generated by Cloudflare]
Proxy: Enabled â˜ï¸
```

---

## âœ… Verification

### Test Templates Bucket:
```bash
# Check if domain is working
curl -I https://stantemplates.cloud.stanlink.online

# Should return:
# HTTP/2 200
# server: cloudflare
# ...
```

### Test Assets Bucket:
```bash
# Check if domain is working
curl -I https://stanassets.cloud.stanlink.online

# Should return:
# HTTP/2 200
# server: cloudflare
# ...
```

### Test File Access:
```bash
# Upload a test file first, then:
curl https://stantemplates.cloud.stanlink.online/test.txt

# Should return the file content
```

---

## ğŸ¨ Optional: Custom Caching Rules

### Aggressive Caching for Templates (Recommended):
```
Cloudflare Dashboard â†’ Rules â†’ Page Rules

URL: stantemplates.cloud.stanlink.online/*
Settings:
- Cache Level: Cache Everything
- Edge Cache TTL: 1 month
- Browser Cache TTL: 1 day
```

### Moderate Caching for Assets:
```
URL: stanassets.cloud.stanlink.online/*
Settings:
- Cache Level: Cache Everything
- Edge Cache TTL: 1 week
- Browser Cache TTL: 1 day
```

**Benefits:**
- âš¡ Faster downloads (served from edge)
- ğŸ’° Lower R2 costs (fewer reads)
- ğŸŒ Better global performance

---

## ğŸ”’ Optional: Security Rules

### Rate Limiting (Prevent Abuse):
```
Cloudflare Dashboard â†’ Security â†’ WAF â†’ Rate Limiting Rules

Rule: Protect R2 Buckets
Match: hostname in {stantemplates.cloud.stanlink.online, stanassets.cloud.stanlink.online}
Rate: 100 requests per minute per IP
Action: Block for 1 hour
```

### Bot Protection:
```
Cloudflare Dashboard â†’ Security â†’ Bots

Enable Bot Fight Mode for:
- stantemplates.cloud.stanlink.online
- stanassets.cloud.stanlink.online
```

---

## ğŸ“Š Analytics Setup

### Enable Analytics:
```
Cloudflare Dashboard â†’ Analytics â†’ Web Analytics

Add sites:
- stantemplates.cloud.stanlink.online
- stanassets.cloud.stanlink.online

Track:
- Download counts
- Geographic distribution
- Popular templates/assets
- Bandwidth usage
```

---

## ğŸ”„ Update GitHub Secrets

After custom domains are working:

```bash
Repository: unity-build-template
Settings â†’ Secrets â†’ Actions

Update:
STAN_TEMPLATES_PUBLIC_URL = https://stantemplates.cloud.stanlink.online
STAN_ASSETS_PUBLIC_URL = https://stanassets.cloud.stanlink.online
```

---

## ğŸ§ª Testing Workflow

### Test Template Upload:
```yaml
# Trigger workflow with:
mode: template
source_url: https://example.com/test.unitypackage
asset_type: test
rip_template: false

# After upload, verify:
curl https://stantemplates.cloud.stanlink.online/test/base.unitypackage
```

### Test Asset Upload:
```yaml
# Trigger workflow with:
mode: asset-single
source_url: https://example.com/test.fbx
asset_type: models

# After upload, verify:
curl https://stanassets.cloud.stanlink.online/library/models/asset_[timestamp]
```

---

## ğŸš¨ Troubleshooting

### Domain Not Working After 10 Minutes:
```bash
# Check DNS propagation
dig stantemplates.cloud.stanlink.online

# Should show CNAME record
# If not, check Cloudflare DNS settings
```

### 403 Forbidden Error:
```bash
# Make sure public access is enabled
Cloudflare Dashboard â†’ R2 â†’ [bucket] â†’ Settings â†’ Public Access â†’ Allow
```

### 404 Not Found:
```bash
# File might not exist or path is wrong
# List bucket contents:
aws s3 ls s3://stan-templates/ --endpoint-url https://[account-id].r2.cloudflarestorage.com
```

### Slow Downloads:
```bash
# Enable caching (see Optional: Custom Caching Rules above)
# Check Cloudflare Analytics for cache hit rate
```

---

## ğŸ’¡ Pro Tips

1. **Use Subdomains**: `cloud.stanlink.online` is cleaner than `stanlink.online/cloud`

2. **Enable Compression**: Cloudflare auto-compresses, but verify in Page Rules

3. **Monitor Bandwidth**: Set up alerts in Cloudflare for unusual traffic

4. **Backup Dev URLs**: Keep dev URLs as fallback in case of DNS issues

5. **SSL/TLS**: Cloudflare provides free SSL automatically - no setup needed!

6. **Purge Cache**: After uploading new files, purge cache in Cloudflare Dashboard

---

## ğŸ“ˆ Performance Comparison

### Dev URL (pub-xxxxx.r2.dev):
- â±ï¸ First byte: ~200ms
- ğŸ“Š Rate limit: ~1000 req/min
- ğŸŒ CDN: Basic
- ğŸ’° Cost: Free but limited

### Custom Domain (stantemplates.cloud.stanlink.online):
- â±ï¸ First byte: ~50ms (with caching)
- ğŸ“Š Rate limit: Unlimited (with Pro plan)
- ğŸŒ CDN: Full Cloudflare network
- ğŸ’° Cost: Free (included with Cloudflare)

**Result: 4x faster + unlimited scale!** ğŸš€

---

## ğŸ¯ Final Checklist

- [ ] Custom domain added to stan-templates
- [ ] Custom domain added to stan-assets
- [ ] DNS records configured
- [ ] Public access enabled on both buckets
- [ ] Domains verified (curl test)
- [ ] GitHub secrets updated
- [ ] Caching rules configured (optional)
- [ ] Security rules configured (optional)
- [ ] Analytics enabled (optional)
- [ ] Test upload completed
- [ ] Test download completed

**You're ready to scale to millions of users!** ğŸ‰
