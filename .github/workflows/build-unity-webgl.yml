name: Build Unity WebGL

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID from STAN'
        required: true
        type: string
      r2_path:
        description: 'R2 path to Unity project (in stan-projects)'
        required: true
        type: string
      game_name:
        description: 'Game name for display'
        required: true
        type: string
      slug:
        description: 'URL-friendly slug for deployment'
        required: true
        type: string
      is_paid:
        description: 'Is paid user (true/false)'
        required: false
        type: string
        default: 'false'

env:
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      
      - name: Download Unity Project from R2
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_SOURCE_BUCKET: stan-projects
        run: |
          echo "üì• Downloading Unity project from R2..."
          pip install awscli
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          mkdir -p UnityProject
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.r2_path }} ./UnityProject \
            --endpoint-url $R2_ENDPOINT
          echo "‚úÖ Project downloaded"

      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: UnityProject/Library
          key: Library-${{ github.event.inputs.slug }}-${{ hashFiles('UnityProject/Assets/**', 'UnityProject/Packages/**') }}
          restore-keys: |
            Library-${{ github.event.inputs.slug }}-
            Library-

      # Build with GameCI Docker Image
      - name: Build Unity WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          targetPlatform: WebGL
          projectPath: UnityProject
          unityVersion: 2022.3.21f1
          buildName: "WebGL"
          
      - name: Update project metadata with build settings
        run: |
          echo "üìä Fetching build settings from database..."
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ github.event.inputs.project_id }}/build-settings")
          IS_KIDS_SAFE=$(echo "$RESPONSE" | jq -r '.is_kids_safe // false')
          
          if [ -f "UnityProject/stan-project.json" ]; then
            jq ".isKidsSite = $IS_KIDS_SAFE" UnityProject/stan-project.json > tmp.json
            mv tmp.json UnityProject/stan-project.json
          fi
      
      - name: Inject Stan Monetization
        run: |
          # Copy build to expected location for injection script if needed
          # GameCI builds to build/WebGL by default
          mkdir -p build/WebGL/WebGL
          cp -r build/WebGL/* build/WebGL/WebGL/ 2>/dev/null || true
          node inject-ads.js
      
      - name: Deploy to R2 Games Bucket
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_GAMES_BUCKET: stan-games
        run: |
          echo "üöÄ Deploying WebGL build to R2 pool..."
          pip install awscli
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          aws s3 sync build/WebGL/WebGL s3://stan-games/${{ github.event.inputs.slug }} \
            --endpoint-url $R2_ENDPOINT \
            --delete
      
      - name: Notify STAN Backend (Success)
        if: success()
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.inputs.project_id }}",
              "status": "success",
              "deploy_url": "https://games.stanlink.online/${{ github.event.inputs.slug }}",
              "game_name": "${{ github.event.inputs.game_name }}"
            }'
          
          curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-succesful" \
            -H "Content-Type: application/json" \
            -d '{
              "to": "${{ secrets.NOTIFICATION_EMAIL }}",
              "sender": "stan",
              "variables": {
                "subject": "üéÆ ${{ github.event.inputs.game_name }} - Unity Build Complete!",
                "game_name": "${{ github.event.inputs.game_name }}",
                "engine": "Unity",
                "play_url": "https://games.stanlink.online/${{ github.event.inputs.slug }}"
              }
            }'
      
      - name: Notify STAN Backend (Failure)
        if: failure()
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.inputs.project_id }}",
              "status": "failed",
              "game_name": "${{ github.event.inputs.game_name }}"
            }'
          
          curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-failed" \
            -H "Content-Type: application/json" \
            -d '{
              "to": "${{ secrets.NOTIFICATION_EMAIL }}",
              "sender": "stan",
              "variables": {
                "subject": "‚ùå ${{ github.event.inputs.game_name }} - Unity Build Failed",
                "game_name": "${{ github.event.inputs.game_name }}",
                "engine": "Unity",
                "error_message": "Build failed during GitHub Actions workflow"
              }
            }'

      - name: Cleanup
        if: always()
        run: |
          rm -rf ./UnityProject
          rm -rf build/
