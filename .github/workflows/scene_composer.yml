name: Scene Composer

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      scene_path:
        description: 'Scene path'
        required: true
      operations:
        description: 'JSON array of scene operations'
        required: true

jobs:
  compose:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rclone & Download
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          
          R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}"
          if [ -z "$R2_ENDPOINT" ]; then
             R2_ENDPOINT="https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com"
          else
             # Sanitize: Strip potential bucket path
             R2_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          fi

          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = $R2_ENDPOINT
          acl = private
          EOF
          
          # Download project
          rclone copy "r2:stan-projects/${{ inputs.project_id }}" ./project --progress

      - name: Inject SceneComposer Script
        run: |
           cat > SceneComposer.cs << 'EOF'
           using UnityEngine;
           using UnityEditor;
           using UnityEditor.SceneManagement;
           using System.Collections.Generic;

           public class SceneComposer
           {
               public static void Execute()
               {
                   var operations = System.Environment.GetEnvironmentVariable("OPERATIONS");
                   var scenePath = System.Environment.GetEnvironmentVariable("SCENE_PATH");
                   
                   if (string.IsNullOrEmpty(scenePath)) { Debug.LogError("SCENE_PATH missing"); return; }
                   
                   var scene = EditorSceneManager.OpenScene(scenePath, OpenSceneMode.Single);
                   var ops = JsonUtility.FromJson<OperationList>(operations);
                   
                   foreach (var op in ops.operations)
                   {
                       switch (op.type)
                       {
                           case "create_scene":
                               // Handled by default or explicit creation if needed
                               break;
                           case "add_gameobject":
                               var go = new GameObject(op.name);
                               if (!string.IsNullOrEmpty(op.parent))
                               {
                                   var parent = GameObject.Find(op.parent);
                                   if (parent) go.transform.SetParent(parent.transform);
                               }
                               if (op.position != null) go.transform.position = op.position;
                               break;
                           // Add other cases as needed
                       }
                   }
                   EditorSceneManager.SaveScene(scene);
               }
           }
           
           [System.Serializable]
           public class OperationList { public List<Operation> operations; }
           [System.Serializable]
           public class Operation 
           { 
               public string type; 
               public string name; 
               public string parent;
               public Vector3 position;
           }
           EOF
           mkdir -p project/Assets/Editor
           mv SceneComposer.cs project/Assets/Editor/

      - name: Run Scene Composition (GameCI)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          OPERATIONS: ${{ inputs.operations }}
          SCENE_PATH: ${{ inputs.scene_path }}
        with:
          projectPath: ./project
          unityVersion: 2022.3.10f1
          buildMethod: SceneComposer.Execute
          customParameters: -nographics -batchmode -quit

      - name: Upload Changes
        run: |
          rclone sync ./project "r2:stan-projects/${{ inputs.project_id }}" \
            --progress \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**'
