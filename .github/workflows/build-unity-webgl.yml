name: Build Unity WebGL

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID from STAN'
        required: true
        type: string
      r2_path:
        description: 'R2 path to Unity project (in stan-projects)'
        required: true
        type: string
      game_name:
        description: 'Game name for display'
        required: true
        type: string
      slug:
        description: 'URL-friendly slug for deployment'
        required: true
        type: string
      is_paid:
        description: 'Is paid user (true/false)'
        required: false
        type: string
        default: 'false'

env:
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_MANUAL_LICENSE: ${{ secrets.UNITY_MANUAL_LICENSE }}

jobs:
  setup-unity:
    runs-on: ubuntu-latest
    outputs:
      unity-path: ${{ steps.set-path.outputs.path }}
      activation-method: ${{ steps.activate-unity.outputs.method }}
      unity-version: "2022.3.21f1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Unity Installation
        id: cache-unity
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v4
          restore-keys: |
            unity-2022.3.21f1-linux-

      - name: Install Unity (if not cached)
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "üì¶ Installing Unity Editor..."
          sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl gnupg
          curl -fsSL https://unity.com/unity-hub/repos/apt/unityhub.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/unityhub.gpg
          echo "deb [signed-by=/etc/apt/keyrings/unityhub.gpg] https://unity.com/unity-hub/repos/apt/ stable main" | sudo tee /etc/apt/sources.list.d/unityhub.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y unityhub
          
          sudo mkdir -p /opt/unity
          sudo chmod 777 /opt/unity
          
          unityhub --headless install --version 2022.3.21f1 --changeset bf09ca542b87 --installPath /opt/unity
          
          echo "‚úÖ Unity installation completed"

      - name: Set Unity Path Output
        id: set-path
        run: |
          echo "path=/opt/unity/2022.3.21f1/Editor/Unity" >> $GITHUB_OUTPUT

      - name: Activate Unity
        id: activate-unity
        run: |
          UNITY_EXE="/opt/unity/2022.3.21f1/Editor/Unity"
          echo "üîë Attempting Unity activation..."
          
          mkdir -p ~/.local/share/unity3d/Unity/
          if [ -n "${{ env.UNITY_LICENSE }}" ]; then
            echo "${{ env.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
            if "$UNITY_EXE" -quit -batchmode -nographics -createProject /tmp/license_test -logFile license_test.log; then
              echo "‚úÖ License file activation successful!"
              echo "method=license_file" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          if [ -n "${{ env.UNITY_SERIAL }}" ]; then
             if "$UNITY_EXE" -quit -batchmode -nographics -serial "${{ env.UNITY_SERIAL }}" -username "${{ env.UNITY_EMAIL }}" -password "${{ env.UNITY_PASSWORD }}" -logFile serial_test.log; then
                echo "‚úÖ Serial activation successful!"
                echo "method=serial_license" >> $GITHUB_OUTPUT
                exit 0
             fi
          fi

          echo "method=failed" >> $GITHUB_OUTPUT
          exit 1

  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: setup-unity
    if: needs.setup-unity.outputs.activation-method != 'failed'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Unity Project from R2
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_SOURCE_BUCKET: stan-projects
        run: |
          echo "üì• Downloading Unity project from R2..."
          pip install awscli
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          mkdir -p UnityProject
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.r2_path }} ./UnityProject \
            --endpoint-url $R2_ENDPOINT
          echo "‚úÖ Project downloaded"

      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: UnityProject/Library
          key: Library-${{ github.event.inputs.slug }}-${{ hashFiles('UnityProject/Assets/**', 'UnityProject/Packages/**') }}
          restore-keys: |
            Library-${{ github.event.inputs.slug }}-
            Library-

      - name: Restore Unity Cache
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v4
          
      - name: Restore Unity License
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          if [ "${{ needs.setup-unity.outputs.activation-method }}" == "license_file" ]; then
             mkdir -p ~/.local/share/unity3d/Unity/
             echo "${{ env.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
          fi
      
      - name: Build Unity WebGL
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          echo "üéÆ Building Unity WebGL..."
          mkdir -p build/WebGL
          "$UNITY_EXE" -batchmode -quit -projectPath ./UnityProject -buildTarget WebGL -buildPath ./build/WebGL/WebGL -logFile build.log
          
      - name: Update project metadata with build settings
        run: |
          echo "üìä Fetching build settings from database..."
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ github.event.inputs.project_id }}/build-settings")
          IS_KIDS_SAFE=$(echo "$RESPONSE" | jq -r '.is_kids_safe // false')
          
          if [ -f "UnityProject/stan-project.json" ]; then
            jq ".isKidsSite = $IS_KIDS_SAFE" UnityProject/stan-project.json > tmp.json
            mv tmp.json UnityProject/stan-project.json
          fi
      
      - name: Inject Stan Monetization
        run: |
          node inject-ads.js
      
      - name: Deploy to R2 Games Bucket
        env:
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_GAMES_BUCKET: stan-games
        run: |
          echo "üöÄ Deploying WebGL build to R2 pool..."
          pip install awscli
          aws configure set aws_access_key_id $R2_ACCESS_KEY
          aws configure set aws_secret_access_key $R2_SECRET_KEY
          aws configure set default.region auto
          aws s3 sync build/WebGL/WebGL s3://stan-games/${{ github.event.inputs.slug }} \
            --endpoint-url $R2_ENDPOINT \
            --delete
      
      - name: Notify STAN Backend (Success)
        if: success()
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.inputs.project_id }}",
              "status": "success",
              "deploy_url": "https://games.stanlink.online/${{ github.event.inputs.slug }}",
              "game_name": "${{ github.event.inputs.game_name }}"
            }'
          
          curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-succesful" \
            -H "Content-Type: application/json" \
            -d '{
              "to": "${{ secrets.NOTIFICATION_EMAIL }}",
              "sender": "stan",
              "variables": {
                "subject": "üéÆ ${{ github.event.inputs.game_name }} - Unity Build Complete!",
                "game_name": "${{ github.event.inputs.game_name }}",
                "engine": "Unity",
                "play_url": "https://games.stanlink.online/${{ github.event.inputs.slug }}"
              }
            }'
      
      - name: Notify STAN Backend (Failure)
        if: failure()
        env:
          STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
          STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        run: |
          curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
            -H "Authorization: Bearer $STAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.inputs.project_id }}",
              "status": "failed",
              "game_name": "${{ github.event.inputs.game_name }}"
            }'
          
          curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-failed" \
            -H "Content-Type: application/json" \
            -d '{
              "to": "${{ secrets.NOTIFICATION_EMAIL }}",
              "sender": "stan",
              "variables": {
                "subject": "‚ùå ${{ github.event.inputs.game_name }} - Unity Build Failed",
                "game_name": "${{ github.event.inputs.game_name }}",
                "engine": "Unity",
                "error_message": "Build failed during GitHub Actions workflow"
              }
            }'
      
      - name: Return Unity License
        if: always()
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          "$UNITY_EXE" -batchmode -quit -returnlicense -logFile return_license.log || true

      - name: Cleanup
        if: always()
        run: |
          rm -rf ./UnityProject
          rm -rf build/