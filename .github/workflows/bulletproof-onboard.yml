name: Bulletproof Unity Onboard

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      template_package:
        description: 'Unity package name or empty for base project'
        required: false
        default: ''
      is_paid:
        description: 'Is paid user (true/false)'
        required: true
        default: 'false'
      allowed_domains:
        description: 'Comma-separated allowed domains'
        required: true
        default: 'games.stanlink.online'

env:
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

jobs:
  onboard-project:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Clone Base Project
        run: |
          echo "ðŸ“¦ Cloning stanstarter base project..."
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          echo "âœ… Base project cloned"
      
      - name: Import Template
        if: ${{ inputs.template_package != '' }}
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          STAN_TEMPLATES_PUBLIC_URL: ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}
        with:
          targetPlatform: WebGL
          projectPath: project
          unityVersion: 2022.3.21f1
          customParameters: -importPackage $(curl -L -f ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}/${{ inputs.template_package }} -o template.unitypackage && echo $(pwd)/template.unitypackage) -quit -batchmode -nographics
          buildName: "Importing"
          skipBuild: true
      
      - name: Configure Project
        run: |
          echo "âš™ï¸ Configuring project settings..."
          
          # Replace placeholders in core scripts
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs
          
          # Create stan-config.json
          cat > project/Assets/_StanCore/Resources/stan-config.json << EOF
          {
            "domains": ["${{ inputs.allowed_domains }}"],
            "projectId": "${{ inputs.project_id }}",
            "isPaid": ${{ inputs.is_paid }}
          }
          EOF
          
          echo "âœ… Project configured"
      
      - name: Upload to R2
        env:
           R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
           R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
           R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          echo "â˜ï¸ Uploading project to R2..."
          
          # Install rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # Configure rclone
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com
          region = auto
          EOF
          
          # Create bucket path and upload
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} \
            --progress \
            --exclude '.git/**' \
            --exclude 'Library/**' \
            --exclude 'Temp/**' \
            --exclude 'Logs/**'
          
          echo "âœ… Project uploaded to R2"
      
      - name: Notify Backend
        run: |
          echo "ðŸ“¡ Notifying backend of successful onboarding..."
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{ 
              "status": "onboarded",
              "template": "${{ inputs.template_package }}",
              "templateImported": true,
              "unityActivated": true,
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Backend notified"

  handle-failure:
    runs-on: ubuntu-latest
    needs: onboard-project
    if: failure()
    
    steps:
      - name: Fallback to Base Project
        env:
           R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
           R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
           R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          echo "âš ï¸ Onboarding failed - creating base project fallback"
          
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          
          curl https://rclone.org/install.sh | sudo bash
          
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com
          region = auto
          EOF
          
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} --progress
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{ 
              "status": "onboarded_base_only",
              "template": "",
              "templateImported": false,
              "unityActivated": false,
              "activationMethod": "failed",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Base project created as fallback"