name: Bulletproof Unity Onboard

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
      template_package:
        description: 'Unity package name or empty for base project'
        required: false
        default: ''
      is_paid:
        description: 'Is paid user (true/false)'
        required: true
        default: 'false'
      allowed_domains:
        description: 'Comma-separated allowed domains'
        required: true
        default: 'games.stanlink.online'

env:
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_MANUAL_LICENSE: ${{ secrets.UNITY_MANUAL_LICENSE }}

jobs:
  setup-unity:
    runs-on: ubuntu-latest
    outputs:
      unity-path: ${{ steps.set-path.outputs.path }}
      activation-method: ${{ steps.activate-unity.outputs.method }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Cache Unity Installation
        id: cache-unity
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v2
      
      - name: Install Unity (if not cached)
        id: install-unity
        if: steps.cache-unity.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ“¦ Installing Unity Editor..."
          sudo apt-get update && sudo apt-get install -y --no-install-recommends ca-certificates curl gnupg
          curl -fsSL https://unity.com/unity-hub/repos/apt/unityhub.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/unityhub.gpg
          echo "deb [signed-by=/etc/apt/keyrings/unityhub.gpg] https://unity.com/unity-hub/repos/apt/ stable main" | sudo tee /etc/apt/sources.list.d/unityhub.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y unityhub
          
          sudo mkdir -p /opt/unity
          sudo chmod 777 /opt/unity
          
          unityhub --headless install --version 2022.3.21f1 --changeset bf09ca542b87 --installPath /opt/unity
          
          echo "âœ… Unity installation completed"

      - name: Set Unity Path Output
        id: set-path
        run: |
          echo "path=/opt/unity/2022.3.21f1/Editor/Unity" >> $GITHUB_OUTPUT
      
      - name: Activate Unity (Multiple Methods)
        id: activate-unity
        run: |
          UNITY_EXE="/opt/unity/2022.3.21f1/Editor/Unity"
          echo "ðŸ”‘ Attempting Unity activation..."
          
          # Method 1: License File
          mkdir -p ~/.local/share/unity3d/Unity/
          if [ -n "${{ env.UNITY_LICENSE }}" ]; then
            echo "${{ env.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
            if "$UNITY_EXE" -quit -batchmode -nographics -createProject /tmp/license_test -logFile license_test.log; then
              echo "âœ… License file activation successful!"
              echo "method=license_file" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Method 2: Serial
          if [ -n "${{ env.UNITY_SERIAL }}" ]; then
             if "$UNITY_EXE" -quit -batchmode -nographics -serial "${{ env.UNITY_SERIAL }}" -username "${{ env.UNITY_EMAIL }}" -password "${{ env.UNITY_PASSWORD }}" -logFile serial_test.log; then
                echo "âœ… Serial activation successful!"
                echo "method=serial_license" >> $GITHUB_OUTPUT
                exit 0
             fi
          fi
          
          echo "method=failed" >> $GITHUB_OUTPUT
          exit 1

  onboard-project:
    runs-on: ubuntu-latest
    needs: setup-unity
    if: needs.setup-unity.outputs.activation-method != 'failed'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Clone Base Project
        run: |
          echo "ðŸ“¦ Cloning stanstarter base project..."
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          echo "âœ… Base project cloned"
      
      - name: Restore Unity Cache
        uses: actions/cache@v3
        with:
          path: /opt/unity
          key: unity-2022.3.21f1-linux-v2
      
      - name: Restore Unity License
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          if [ "${{ needs.setup-unity.outputs.activation-method }}" == "license_file" ]; then
             mkdir -p ~/.local/share/unity3d/Unity/
             echo "${{ env.UNITY_LICENSE }}" | base64 -d > ~/.local/share/unity3d/Unity/Unity_lic.ulf
          fi
      
      - name: Import Template (if specified)
        if: ${{ inputs.template_package != '' }}
        env:
          STAN_TEMPLATES_PUBLIC_URL: ${{ secrets.STAN_TEMPLATES_PUBLIC_URL }}
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          TEMPLATE_PATH="${{ inputs.template_package }}"
          TEMPLATE_PATH="${TEMPLATE_PATH#templates/}"
          ENCODED_PATH=$(echo "$TEMPLATE_PATH" | sed 's/ /%20/g')
          FULL_URL="${STAN_TEMPLATES_PUBLIC_URL}/${ENCODED_PATH}"
          
          curl -L -f "$FULL_URL" -o template.unitypackage
          
          "$UNITY_EXE" -quit -batchmode -nographics -projectPath ./project -importPackage $(pwd)/template.unitypackage -logFile import_template.log
          
          echo "âœ… Template imported successfully"
      
      - name: Configure Project
        run: |
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs
          
          cat > project/Assets/_StanCore/Resources/stan-config.json << EOF
          {
            "domains": ["${{ inputs.allowed_domains }}"],
            "projectId": "${{ inputs.project_id }}",
            "isPaid": ${{ inputs.is_paid }}
          }
          EOF
          
          echo "âœ… Project configured"
      
      - name: Test Unity Project
        run: |
          UNITY_EXE="${{ needs.setup-unity.outputs.unity-path }}"
          "$UNITY_EXE" -quit -batchmode -nographics -projectPath ./project -executeMethod UnityEditor.EditorApplication.Exit -logFile test_compile.log
          echo "âœ… Project compilation test passed"
      
      - name: Upload to R2
        env:
           R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
           R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
           R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          CLEAN_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = $R2_ACCESS_KEY
          secret_access_key = $R2_SECRET_KEY
          endpoint = $CLEAN_ENDPOINT
          region = auto
          EOF
          
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} --progress --exclude '.git/**' --exclude 'Library/**' --exclude 'Temp/**' --exclude 'Logs/**'
          
          echo "âœ… Project uploaded to R2"
      
      - name: Notify Backend
        run: |
          echo "ðŸ“¡ Notifying backend of successful onboarding..."
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{
              "status": "onboarded",
              "template": "${{ inputs.template_package }}",
              "templateImported": true,
              "unityActivated": true,
              "activationMethod": "${{ needs.setup-unity.outputs.activation-method }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Backend notified"

handle-failure:
    runs-on: ubuntu-latest
    needs: setup-unity
    if: needs.setup-unity.outputs.activation-method == 'failed'
    
    steps:
      - name: Fallback to Base Project
        env:
           R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
           R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
           R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        run: |
          echo "âš ï¸ Unity activation failed - creating base project without Unity processing"
          
          git clone https://github.com/StaNLink-Inc/stanstarter.git project
          rm -rf project/.git
          
          sed -i 's/{{PROJECT_ID}}/${{ inputs.project_id }}/g' project/Assets/_StanCore/Scripts/StanAnalytics.cs || true
          sed -i 's/{{IS_PAID}}/${{ inputs.is_paid }}/g' project/Assets/_StanCore/Scripts/StanWatermark.cs || true
          sed -i 's/{{ALLOWED_DOMAINS}}/${{ inputs.allowed_domains }}/g' project/Assets/_StanCore/Scripts/StanDomainLock.cs || true
          
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          CLEAN_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = $R2_ACCESS_KEY
          secret_access_key = $R2_SECRET_KEY
          endpoint = $CLEAN_ENDPOINT
          region = auto
          EOF
          
          rclone mkdir r2:stan-projects/${{ inputs.project_id }}
          rclone sync ./project r2:stan-projects/${{ inputs.project_id }} --progress
          
          curl -X POST "https://stan-backend.stanleyisaac134.workers.dev/api/projects/${{ inputs.project_id }}/onboarded" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.STAN_API_KEY }}" \
            -d '{
              "status": "onboarded_base_only",
              "template": "",
              "templateImported": false,
              "unityActivated": false,
              "activationMethod": "failed",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
          
          echo "âœ… Base project created as fallback"
