name: Build Validator

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rclone & Download
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}"
          if [ -z "$R2_ENDPOINT" ]; then
             R2_ENDPOINT="https://c4bfd8b7429b61b9122497ec401f7693.r2.cloudflarestorage.com"
          else
             # Sanitize: Strip potential bucket path
             R2_ENDPOINT=$(echo "$R2_ENDPOINT" | sed 's|\.r2\.cloudflarestorage\.com.*|.r2.cloudflarestorage.com|')
          fi
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = $R2_ENDPOINT
          acl = private
          EOF
          rclone copy "r2:stan-projects/${{ inputs.project_id }}" ./project --progress

      - name: Inject BuildValidator Script
        run: |
          cat > BuildValidator.cs << 'EOF'
          using UnityEngine;
          using UnityEditor;
          using System.Collections.Generic;
          public class BuildValidator {
              public static void Execute() {
                  Debug.Log("Validating build...");
                  // Validation logic
                  EditorApplication.Exit(0);
              }
          }
          EOF
          mkdir -p project/Assets/Editor
          mv BuildValidator.cs project/Assets/Editor/

      - name: Run Validation (GameCI)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          projectPath: ./project
          unityVersion: 2022.3.10f1
          buildMethod: BuildValidator.Execute
          customParameters: -nographics -batchmode -quit
          allowDirtyBuild: true
          versioning: None

      - name: Return License
        uses: game-ci/unity-return-license@v2
        if: always()
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
